---
title: "Merge IC cores"
author: "K Todd-Brown"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(readxl)
library(tidyverse)

source('../R/read_ReynoldsData.R')
source('../R/read_SiteTextureData.R')

dataDir <- '~/Documents/Professional/Datasets/Renyolds-CZO/data'
```

# Read in data
```{r setReads}
ICReads <- read_ReynoldsData(dataDir=dataDir)

site.df <- ICReads$site
pit.df <- ICReads$pit
mass.df <- ICReads$mass
inorganicC.df <- ICReads$inorganicC


texture.df <- read_SiteTextureData(dataDir=dataDir) %>%
  mutate(`Sand (g)` = `Ashed Mass (g)`,
         `Clay (g)` = `Hydro Reading` - `Blank Reading`,
         `Total (by oven) (g)` = `Mass Dried (g)` - 
           (`Wet Sieved + Oven dry mass (g)` - `Ashed Mass (g)`) ) %>%
  mutate(`Silt (g)` = `Total (by oven) (g)` - `Clay (g)` - `Sand (g)`) %>%
  mutate(core = if_else(grepl('[RLC]$', sheet_name),
                        substr(sheet_name, 1, nchar(sheet_name)-1),
                        sheet_name),
         ID_sample = if_else(grepl('[RLC]$', sheet_name),
                        substr(sheet_name, nchar(sheet_name), nchar(sheet_name)),
                        '')) %>%
  mutate(core = recode(core, 'Dry1'='DRY1', 'Off1' = 'OFF1', 'Off2'='OFF2')) %>%
  separate(`Depth (cm)`, into=c('Depth top (cm)', 'ID_Depth_cm'), sep='-', remove=FALSE) %>%
  mutate(`Depth (cm)`=paste0("'",`Depth (cm)`)) %>%
  mutate(source_file = 'Site_textue (1).xlsx') %>%
  select(source_file, sheet_name, core, `Depth (cm)`, ID_Depth_cm, ID_sample,
         `Blank Reading`, `Hydro Reading`, `Temperature (C)`, 
         `Mass Dried (g)`, `Wet Sieved + Oven dry mass (g)`, `Ashed Mass (g)`,
         `Total (by oven) (g)`, `Sand (g)`, `Clay (g)`, `Silt (g)`)

##TODO core names don't match between mass.df and texture.df
```
 
```{r writeNewWS}
write_excel_csv(site.df, file.path('..', 'temp', 'Reynolds_data', 'site.csv'))
write_excel_csv(pit.df, file.path('..', 'temp', 'Reynolds_data', 'pit.csv'))
write_excel_csv(mass.df, file.path('..', 'temp', 'Reynolds_data', 'mass.csv'))
write_excel_csv(inorganicC.df, file.path('..', 'temp', 'Reynolds_data', 'inorganicC.csv'))

write_excel_csv(texture.df, file.path('..', 'temp', 'Site_texture', 'texture.csv'))
```

# QA/QC
 
## Site.df
```{r}
site.df <- site.df %>% 
  mutate_at(vars(c(E, N, Elevation_m, Slope_degrees, Aspect_degrees)), as.numeric)

ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=Elevation_m)) +
  theme_bw()

``` 
 
```{r basicVis}
ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=core %in% mass.df$core)) +
  theme_bw()
ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=core %in% inorgnicC.df$core)) +
  theme_bw()


soil.df <- inorgnicC.df %>%
  mutate(ID_fraction = if_else(ID_fraction %in% c('G', 'GRAVEL'),
                               'Gravel_IC_percent', 'Fine_IC_percent')) %>%
  spread(key=ID_fraction, value=IC_percent) %>%
  full_join(mass.df) %>%
  mutate_at(vars(-core, -ID_sample), as.numeric) %>%
  mutate_at(c('core', 'ID_sample'), as.factor) %>%
  mutate(Gravel_IC_percent = case_when(is.na(Gravel_IC_percent) ~ 1e-4, 
                                       Gravel_IC_percent < 1e-4 ~ 1e-4,
                                       TRUE ~ Gravel_IC_percent),
         Fine_IC_percent = case_when(is.na(Fine_IC_percent) ~ 1e-4, 
                                       Fine_IC_percent < 1e-4 ~ 1e-4,
                                       TRUE ~ Fine_IC_percent))
  
  
write_excel_csv(soil.df, file.path('..', 'temp', 'Reynolds_data', 'filled_massIC.csv'))
```
```{r}
plot.df <- soil.df %>%
  mutate(plotGroup = paste(core, ID_sample),
         total_IC_percent = (Fine_IC_percent*Fine_mass_g + Gravel_IC_percent*Gravel_mass_g) / 
                  (Fine_mass_g+Gravel_mass_g)) %>%
  gather(key='fraction', value='IC (percent)', contains('IC'))

ggplot(plot.df) +
  geom_line(aes(x=-ID_Depth_cm, y=`IC (percent)`, group=plotGroup)) +
  coord_flip() +
  facet_wrap(~fraction)

ggplot(mass.df %>%
         mutate_at(vars(c(ID_Depth_cm, contains('mass'))), as.numeric) %>%
         mutate(plotGroup = paste(core, ID_sample),
                gravel_fraction = Gravel_mass_g/(Fine_mass_g + Gravel_mass_g))) +
  geom_line(aes(x=-ID_Depth_cm, y=gravel_fraction, group=plotGroup)) +
  coord_flip()
```
