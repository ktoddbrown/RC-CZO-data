---
title: "Merge IC cores"
author: "K Todd-Brown"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(readxl)
library(tidyverse)

source('../R/read_ReynoldsData.R')

dataDir <- '~/Documents/Professional/Datasets/Renyolds-CZO/data'
```

# Read in data
```{r setReads}
ICReads <- read_ReynoldsData(dataDir=dataDir)

site.df <- ICReads$site
pit.df <- ICReads$pit
mass.df <- ICReads$mass
inorganicC.df <- ICReads$inorganicC
```
 
```{r writeNewWS}
write_excel_csv(site.df, file.path('..', 'temp', 'Reynolds_data', 'site.csv'))
write_excel_csv(pit.df, file.path('..', 'temp', 'Reynolds_data', 'pit.csv'))
write_excel_csv(mass.df, file.path('..', 'temp', 'Reynolds_data', 'mass.csv'))
write_excel_csv(inorgnicC.df, file.path('..', 'temp', 'Reynolds_data', 'inorganicC.csv'))
```

# QA/QC
 
## Site.df
```{r}
site.df <- site.df %>% 
  mutate_at(vars(c(E, N, Elevation_m, Slope_degrees, Aspect_degrees)), as.numeric)

ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=Elevation_m)) +
  theme_bw()

``` 
 
```{r basicVis}
ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=core %in% mass.df$core)) +
  theme_bw()
ggplot(site.df) +
  #geom_point(aes(x=E, y=N), color='yellow') +
  geom_point(aes(x=E, y=N, color=core %in% inorgnicC.df$core)) +
  theme_bw()


soil.df <- inorgnicC.df %>%
  mutate(ID_fraction = if_else(ID_fraction %in% c('G', 'GRAVEL'),
                               'Gravel_IC_percent', 'Fine_IC_percent')) %>%
  spread(key=ID_fraction, value=IC_percent) %>%
  full_join(mass.df) %>%
  mutate_at(vars(-core, -ID_sample), as.numeric) %>%
  mutate_at(c('core', 'ID_sample'), as.factor) %>%
  mutate(Gravel_IC_percent = case_when(is.na(Gravel_IC_percent) ~ 1e-4, 
                                       Gravel_IC_percent < 1e-4 ~ 1e-4,
                                       TRUE ~ Gravel_IC_percent),
         Fine_IC_percent = case_when(is.na(Fine_IC_percent) ~ 1e-4, 
                                       Fine_IC_percent < 1e-4 ~ 1e-4,
                                       TRUE ~ Fine_IC_percent))
  
  
write_excel_csv(soil.df, file.path('..', 'temp', 'Reynolds_data', 'filled_massIC.csv'))
```
```{r}
plot.df <- soil.df %>%
  mutate(plotGroup = paste(core, ID_sample),
         total_IC_percent = (Fine_IC_percent*Fine_mass_g + Gravel_IC_percent*Gravel_mass_g) / 
                  (Fine_mass_g+Gravel_mass_g)) %>%
  gather(key='fraction', value='IC (percent)', contains('IC'))

ggplot(plot.df) +
  geom_line(aes(x=-ID_Depth_cm, y=`IC (percent)`, group=plotGroup)) +
  coord_flip() +
  facet_wrap(~fraction)

ggplot(mass.df %>%
         mutate_at(vars(c(ID_Depth_cm, contains('mass'))), as.numeric) %>%
         mutate(plotGroup = paste(core, ID_sample),
                gravel_fraction = Gravel_mass_g/(Fine_mass_g + Gravel_mass_g))) +
  geom_line(aes(x=-ID_Depth_cm, y=gravel_fraction, group=plotGroup)) +
  coord_flip()
```
