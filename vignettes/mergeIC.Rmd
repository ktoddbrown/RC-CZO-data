---
title: "Merge IC cores"
author: "K Todd-Brown"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(readxl)
library(tidyverse)

ICData <- '~/Documents/Professional/Datasets/Renyolds-CZO/data/Reynolds_data (1).xlsx'
```

# Read in data
```{r setReads}


readRanges <- list(DH1=list(sheet_name='DH1', site_name='A1:B1', 
                            dates='D1:E1', site='A3:G4', bulk_density='I19',
                            pit_description='A7:E15',
                            fine_fraction='A20:G50',
                            gravel_fraction='A53:D83'),
                   WH1=list(sheet_name='WH1',
                            site_name='A2:B2', dates='E2:F2', site='A4:G5', bulk_density='E17',
                            pit_description='A8:G13',
                            gravel_fraction='A18:E29'),
                   DRY1=list(sheet_name='DRY1',
                             site_name='A1:B1', dates='D1:E1', 
                             site='A3:G4',
                             bulk_density='E13',
                             pit_description='A7:G11',
                             fine_fraction='A14:E44',
                             gravel_fraction='A47:B77'),
                   OTH1=list(sheet_name='OTH1',
                             site_name='A1:B1', dates='D1:E1', 
                             site='A3:G4',
                             #bulk_density='E13',
                             pit_description='A7:G11'),
                             #fine_fraction='A14:E44',
                             #gravel_fraction='A47:B77')
                   Jun1=list(sheet_name='Jun1',
                             site_name='A1:B1', dates='D1:E1', 
                             site='A3:G4',
                             #bulk_density='E13',
                             pit_description='A7:D11'),
                             #fine_fraction='A14:E44',
                             #gravel_fraction='A47:B77')
                   PAR1=list(sheet_name='PAR1',
                             site_name='A1:B1', 
                             dates_PAR1='H1:I2', #Specal formatting
                             site_PAR1='A2:F3', #Specal formatting
                             bulk_density='F13',
                             pit_description='A5:J11',
                             fine_fraction='A14:F47',
                             gravel_fraction='A91:E124'),
                   Flat1=list(sheet_name='Flat1',
                             site_name='A1:B1', 
                             dates_Flat1='E1:F2', #Specal formatting
                             site_Flat1='A2:G4', #Specal formatting
                             pit_description='A7:I11',
                             bulk_density='E15',
                             fine_fraction='A16:D35',
                             gravel_fraction='A41:L60'),
                   Off1=list(sheet_name='Off1',
                             site_name='A1:B1', 
                             dates_Off1='E1:G1', #Specal formatting
                             site='A3:G4',
                             pit_description='A8:J12',
                             bulk_density='E16',
                             fine_fraction='A17:F44',
                             gravel_fraction='A51:D77'),
                   Hoot1=list(sheet_name='Hoot1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:I12',
                             bulk_density='E15',
                             fine_fraction='A16:F49',
                             gravel_fraction='A52:D85'),
                   Hoot2=list(sheet_name='Hoot2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:I12',
                             bulk_density='E15',
                             fine_fraction='A16:F49',
                             gravel_fraction='A52:B85'),
                   Off2=list(sheet_name='Off2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:I11',
                             bulk_density='E15',
                             fine_fraction='A16:F46',
                             gravel_fraction='A50:D81'),
                   LWS1=list(sheet_name='LWS1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:I13',
                             bulk_density='E16',
                             fine_fraction='A17:F47',
                             gravel_fraction='A50:B80'),
                   NG1=list(sheet_name='NG1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:I13',
                             bulk_density='F15',
                             fine_fraction='A16:F43', #TODO check mislabled table
                             gravel_fraction='A49:D76'),
                   Gate1=list(sheet_name='Gate1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E16',
                             fine_fraction='A17:F24',
                             gravel_fraction='A29:B36'),
                   FRE1=list(sheet_name='FRE1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E15',
                             fine_fraction='A16:F43',
                             gravel_fraction='A48:B75'),
                   RDC1=list(sheet_name='RDC1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J12'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   RDC2=list(sheet_name='RDC2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J12'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   RDC3=list(sheet_name='RDC3',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J12'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   RDH1=list(sheet_name='RDH1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   RDH2=list(sheet_name='RDH2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   Chan1=list(sheet_name='Chan1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR1=list(sheet_name='WHR1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J12'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR2=list(sheet_name='WHR2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J12'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR3=list(sheet_name='WHR3',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR4=list(sheet_name='WHR4',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),#,
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR5=list(sheet_name='WHR5',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4'),
                             #pit_description='A8:J11', #not recorded
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   WHR6=list(sheet_name='WHR6',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4'),
                             #pit_description='A8:J11', #not recorded
                             #bulk_density='E16', # not recorded
                             #fine_fraction='A17:F47', #not recorded
                             #gravel_fraction='A50:B80') #not recorded
                   FLAT2=list(sheet_name='FLAT2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9',
                             bulk_density='E13',
                             fine_fraction='A14:E19',
                             gravel_fraction='A23:D28'),
                   QST1=list(sheet_name='QST1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J14',
                             bulk_density='H19',
                             fine_fraction='A20:F58',
                             gravel_fraction='A62:B100'),
                   QST2=list(sheet_name='QST2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J15',
                             bulk_density='F18',
                             fine_fraction='A19:F32',
                             gravel_fraction='A35:D48'),
                   SCJ1=list(sheet_name='SCJ1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J16',
                             bulk_density='E19',
                             fine_fraction='A20:F48',
                             gravel_fraction='A53:B81'),
                   RR1=list(sheet_name='RR1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J15',
                             bulk_density='E17',
                             fine_fraction='A18:F32',
                             gravel_fraction='A37:B51'),
                   SRB1=list(sheet_name='SRB1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J14',
                             bulk_density='E18',
                             fine_fraction='A19:F34',
                             gravel_fraction='A37:B52'),
                   DHA1=list(sheet_name='DHA1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J16',
                             bulk_density='G19',
                             fine_fraction='A20:F38',
                             gravel_fraction='A41:B59'),
                   WT1=list(sheet_name='WT1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E16',
                             fine_fraction='A17:F26',
                             gravel_fraction='A29:B38'),
                   RR2=list(sheet_name='RR2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E16',
                             fine_fraction='A17:F29',
                             gravel_fraction='A33:B45'),
                   MDR1=list(sheet_name='MDR1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11',
                             bulk_density='E14',
                             fine_fraction='A15:F25',
                             gravel_fraction='A28:B28'),
                   CB1=list(sheet_name='CB1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E16',
                             fine_fraction='A17:F27',
                             gravel_fraction='A31:B41'),
                   WCA1=list(sheet_name='WCA1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),
                             #bulk_density='E19', #not recorded
                             #fine_fraction='A20:F48', #not recorded
                             #gravel_fraction='A53:B81') #not recorded
                   FTR1=list(sheet_name='FTR1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='E16',
                             fine_fraction='A17:F30',
                             gravel_fraction='A34:B47'),
                    MDR2=list(sheet_name='MDR2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J14',
                             bulk_density='E17',
                             fine_fraction='A18:F32',
                             gravel_fraction='A36:B50'),
                    TG1=list(sheet_name='TG1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   WTH1=list(sheet_name='WTH1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   MCR1=list(sheet_name='MCR1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   MC1=list(sheet_name='MC1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J9'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   TG2=list(sheet_name='TG2',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   TG3=list(sheet_name='TG3',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4'),
                             #pit_description='A8:J9'), TODO not recorded in format
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   WHU1=list(sheet_name='WHU1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J11'),
                             #bulk_density='E16', #not recorded
                             #fine_fraction='A17:F30', #not recorded
                             #gravel_fraction='A34:B47'), #not recorded
                   OWL1=list(sheet_name='OWL1',
                             site_name='A1:B1', 
                             dates='E1:F1',
                             site='A3:G4',
                             pit_description='A8:J13',
                             bulk_density='D20',
                             fine_fraction='A22:E26')
                             #gravel_fraction='A34:B47'), #not recorded
)

print(paste('Bad names:', paste(setdiff(names(readRanges), readxl::excel_sheets(ICData)), collapse=', ')))
print(paste('Sheets left out: [', length(setdiff(readxl::excel_sheets(ICData), names(readRanges))),']',  
            paste(setdiff(readxl::excel_sheets(ICData), names(readRanges)), collapse=', ')))
print(paste('Sheets done: [', length(names(readRanges)), ']'))

allTableNames <- unique(unlist(lapply(readRanges, names)))
# readRanges1 <- list(sheet_name=c('DH1', 'WH1'),
#                     site_name=list(DH1='A1:B1', WH1='A2:B2'),
#                     dates=list(DH1='D1:E1', WH1='E2:F2'),
#                     bulk_density=list(DH1='I19', WH1='E17'),
#                     site=list(DH1='A3:G4', WH1= 'A4:G5'),
#               pit_description=list(DH1='A7:E15', WH1='A8:G13'),
#               fine_fraction=list(DH1='A20:G50', WH1=NA),
#               gravel_fraction=list(DH1='A53:D83', WH1='A18:E29'))
```

```{r readData}
rawData <- plyr::llply(readRanges, function(xx){
  plyr::llply(xx[-1], 
              function(yy){
                readxl::read_excel(ICData, sheet=xx$sheet_name, 
                                   range=unlist(yy), col_types = 'text') %>%
                  dplyr::mutate(sheet=xx$sheet_name)})
})

longNames <- c('site_name', 'dates', 'bulk_density')
longTables <- plyr::llply(setNames(longNames, longNames), function(xx){
  #print(xx)
  return(plyr::ldply(rawData, function(yy){
    #print(paste(yy$site_name, names(yy[[xx]])))
    return(names(yy[[xx]]))
    }, .id='core')) #pull long table info
})

tableNames <- setdiff(allTableNames, c('sheet_name', longNames))
wideTables <- plyr::llply(setNames(tableNames, tableNames), function(xx){
  plyr::ldply(rawData, function(yy){yy[[xx]]}, .id='core') #pull wide table info
})
```

# Clean up data
```{r cleanSiteName}
cleanNames <- longTables$site_name %>% select(core, V2) %>% dplyr::rename(site_name = V2) 
cleanBD <- longTables$bulk_density %>% select(core, V1) %>% dplyr::rename(bulk_density = V1)
cleanDates <- longTables$dates %>% select(core, V2) %>% dplyr::rename(sample_date = V2)
cleanSite <- wideTables$site %>% select(-sheet)

site.df <- full_join(cleanNames, cleanBD, by='core') %>%
  full_join(cleanDates, by='core') %>%
  full_join(cleanSite, by='core')

print(site.df)
```

```{r cleanHz}
pit.df <- wideTables$pit_description %>%
  mutate(Effervesence = if_else(is.na(Effervesence), Eff, Effervesence)) %>%
  select(-Eff, -sheet)

print(pit.df)
```

```{r cleanMass}
mass.df <- wideTables$fine_fraction %>%
  select(core, ID, `Soil mass(g)`, `Gravel mass(g)`) %>%
  bind_rows(wideTables$gravel_fraction %>%
              select(core, ID, `Soil mass(g)`, `Gravel mass(g)`)) %>%
  filter(!is.na(`Soil mass(g)`)) %>%
  tidyr::separate(ID, c('sample ID', 'col2', 'col3'), sep='_') %>%
  mutate('Depth' = if_else(is.na(col3), as.numeric(col2), as.numeric(col3))) %>%
  select(core, Depth, `sample ID`, `Soil mass(g)`, `Gravel mass(g)`) %>%
  mutate_at(c('Depth', 'Soil mass(g)', 'Gravel mass(g)'), as.numeric)

print(mass.df)
```

```{r cleanIC}
inorganicC.df <- wideTables$fine_fraction %>%
  select(core, ID, `% IC`) %>% mutate(fraction='fine') %>%
  bind_rows(wideTables$gravel_fraction %>%
              select(core, ID, `% IC`) %>% mutate(fraction='gravel')) %>%
  mutate(`% IC` = as.numeric(gsub('tr', '0.0001', `% IC`))) %>%
  tidyr::separate(ID, c('sample ID', 'col2', 'col3'), sep='_') %>%
  mutate('Depth' = if_else(is.na(col3), as.numeric(col2), as.numeric(col3))) %>%
  select(core, `sample ID`, Depth, fraction, `% IC`) %>%
  mutate_at(c('Depth', '% IC'), as.numeric)

print(inorganicC.df)
```
 
 # QA/QC
 
```{r basicVis}
ggplot(mass.df) +
  geom_line(aes(x=-Depth, y=`Soil mass(g)`, group=`sample ID`)) +
  geom_line(aes(x=-Depth, y=`Gravel mass(g)`, group=`sample ID`), color='red') +
  coord_flip()

ggplot(mass.df) +
  geom_line(aes(x=-Depth, y=`Gravel mass(g)`/`Soil mass(g)`, group=`sample ID`)) +
  coord_flip()

ggplot(inorganicC.df) +
  geom_histogram(aes(x=`% IC`, fill=fraction))
```
